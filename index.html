<script>
document.addEventListener("DOMContentLoaded", () => {
    const video = document.getElementById("main-video");
    const swipeHint = document.getElementById("swipe-hint");
    const wrapper = document.querySelector('.reels-wrapper');

    // Настройка видео
    const urlParams = new URLSearchParams(window.location.search);
    const vParam = urlParams.get('v');
    const folderPath = "./assets/videos/"; 
    const fileName = vParam ? `video-${vParam}.mp4` : "video-1.mp4";
    
    video.src = folderPath + fileName;
    
    // При ошибке - просто пишем в консоль, не пугаем юзера
    video.onerror = function() { console.error("Video Error:", video.src); };

    // Запускаем (muted)
    video.play().catch(() => {});

    let isFirstInteraction = true;
    let touchStartY = 0;
    let touchEndY = 0;
    let isAnimating = false;

    // --- ИСПРАВЛЕННАЯ ФУНКЦИЯ СВАЙПА ---
    function triggerVisualSwipe() {
        if (isAnimating) return;
        isAnimating = true;

        // 1. Включаем звук СРАЗУ (пока браузер видит активность пальца)
        video.muted = false;
        swipeHint.style.display = 'none';

        // 2. Запускаем анимацию ухода вверх
        video.classList.add('slide-out-up');

        // 3. Через 350мс (пока видео скрыто) перематываем
        setTimeout(() => {
            // Перематываем в начало
            video.currentTime = 0;
            
            // Если вдруг видео встало на паузу - пинаем его
            if (video.paused) {
                video.play().catch(e => console.log("Force play error:", e));
            }

            // Меняем анимацию на появление снизу
            video.classList.remove('slide-out-up');
            video.classList.add('slide-in-up');

            // Убираем класс анимации в конце
            setTimeout(() => {
                video.classList.remove('slide-in-up');
                isAnimating = false;
            }, 400);

        }, 350);
    }

    // --- ЛОВИМ СВАЙП ---
    wrapper.addEventListener('touchstart', function(e) {
        touchStartY = e.changedTouches[0].screenY;
    }, {passive: true});

    wrapper.addEventListener('touchend', function(e) {
        touchEndY = e.changedTouches[0].screenY;
        
        // Свайп вверх > 50px
        if (touchStartY - touchEndY > 50) {
            
            if (isFirstInteraction) {
                // Первый раз:
                triggerVisualSwipe(); 
                
                // Генерируем фейк-клик для регистрации Back-Fix
                const fakeClick = new MouseEvent('click', {
                    view: window, bubbles: true, cancelable: true
                });
                wrapper.dispatchEvent(fakeClick);
                
                isFirstInteraction = false;
            } else {
                // Второй раз: снова листаем (бесконечный эффект)
                triggerVisualSwipe();
            }
        }
    }, {passive: true});

    // --- ОБРАБОТЧИК КЛИКОВ ---
    wrapper.addEventListener("click", function(e) {
        if (isFirstInteraction) {
            e.stopPropagation(); // Блокируем редирект
            
            isFirstInteraction = false;
            triggerVisualSwipe(); // Тап тоже запускает анимацию и звук
            console.log("Tap processed -> Animation ON, Redirect BLOCKED");
        } else {
            console.log("Second tap -> Allow Redirect");
            // Тут сработает твой скрипт редиректа сам
        }
    }); 
});
</script>
